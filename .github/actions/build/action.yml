name: "Ubuntu Build"
inputs:
  build_type:
    required: false
    default: "basic"
    type: string
  externalpackages-cache-hit:
    required: true
    default: false
    type: bool

env:
  ISSM_DIR: ${{ github.workspace }}

runs:
  using: "composite"
  steps:
    - name: Install External packages 
      if: ${{ ( inputs.build_type == 'basic') && ( inputs.externalpackages-cache-hit != 'true') }}
      run: |
        cd $ISSM_DIR/externalpackages/triangle && ./install-linux.sh
        cd $ISSM_DIR/externalpackages/m1qn3    && ./install-linux.sh
        cd $ISSM_DIR/externalpackages/petsc    && ./install-3.21-linux.sh
        cd $ISSM_DIR/externalpackages/semic    && ./install.sh

    - name: Install External packages for AD
      if: ${{ ( inputs.build_type == 'codipack') && ( inputs.externalpackages-cache-hit != 'true') }}
      run: |
        cd $ISSM_DIR/externalpackages/triangle   && ./install-linux.sh
        cd $ISSM_DIR/externalpackages/m1qn3      && ./install-linux.sh
        cd $ISSM_DIR/externalpackages/petsc      && ./install-3.20-linux.sh
        cd $ISSM_DIR/externalpackages/gsl        && ./install.sh
        cd $ISSM_DIR/externalpackages/codipack   && ./install.sh
        cd $ISSM_DIR/externalpackages/medipack   && ./install.sh

    - name: Reconfigure ISSM Basic
      if: ${{ inputs.build_type == 'basic'}}
      run: |
        source $ISSM_DIR/etc/environment.sh
          autoreconf -ivf
          ./configure --prefix=${ISSM_DIR} \
          --disable-static \
          --enable-development \
          --enable-debugging \
          --with-numthreads=4 \
          --with-matlab-dir=${{ steps.setup-matlab.outputs.matlabroot }} \
          --with-fortran-lib="-L/usr/lib/x86_64-linux-gnu -lgfortran" \
          --with-mpi-include="${ISSM_DIR}/externalpackages/petsc/install/include" \
          --with-mpi-libflags="-L${ISSM_DIR}/externalpackages/petsc/install/lib -lmpi -lmpicxx -lmpifort" \
          --with-petsc-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-blas-lapack-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-metis-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-parmetis-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-scalapack-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-mumps-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-triangle-dir="${ISSM_DIR}/externalpackages/triangle/install" \
          --with-semic-dir="${ISSM_DIR}/externalpackages/semic/install" \
          --with-m1qn3-dir="${ISSM_DIR}/externalpackages/m1qn3/install"

      - name: Reconfigure ISSM with Codipack
        if: ${{ inputs.build_type == 'codipack'}}
        run: |
          source $ISSM_DIR/etc/environment.sh
          autoreconf -ivf
          ./configure --prefix=${ISSM_DIR} \
          --enable-tape-alloc \
          --enable-development \
          --enable-debugging \
          --with-numthreads=4 \
          --without-kriging \
          --without-kml \
          --without-Sealevelchange \
          --without-Love \
          --with-matlab-dir=${{ steps.setup-matlab.outputs.matlabroot }} \
          --with-fortran-lib="-L/usr/lib/x86_64-linux-gnu -lgfortran" \
          --with-mpi-include="${ISSM_DIR}/externalpackages/petsc/install/include" \
          --with-mpi-libflags="-L${ISSM_DIR}/externalpackages/petsc/install/lib -lmpi -lmpicxx -lmpifort" \
          --with-blas-lapack-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-metis-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-parmetis-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-scalapack-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-mumps-dir="${ISSM_DIR}/externalpackages/petsc/install" \
          --with-triangle-dir="${ISSM_DIR}/externalpackages/triangle/install" \
          --with-gsl-dir="${ISSM_DIR}/externalpackages/gsl/install" \
          --with-m1qn3-dir="${ISSM_DIR}/externalpackages/m1qn3/install" \
          --with-medipack-dir="${ISSM_DIR}/externalpackages/medipack/install" \
          --with-codipack-dir="${ISSM_DIR}/externalpackages/codipack/install"

